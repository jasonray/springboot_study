### Info
this directory contains a reolica of
[prometheus relabel config](https://github.com/mrWinston/relabel-config-playground) repository
### Usage

```sh
PROMETHEUS_VERSION=v2.27.0
docker pull prom/prometheus:$PROMETHEUS_VERSION
```	
```sh
EXPORTER_VERSION=v1.3.1
docker pull prom/node-exporter:$EXPORTER_VERSION
```	
```sh
IMAGE=node-exporter
docker build -t $IMAGE -f Dockerfile.$IMAGE .
```
```sh
NAME=metrics
docker run -p 9100:9100 --name $NAME -d $IMAGE
```

```sh
curl -s $(hostname -i):9100/metrics |  grep "sample_counter"
```	
```text
# HELP sample_counter_one just a sample counter thats always 1 ( except for when you change it )
# TYPE sample_counter_one counter
sample_counter_one{lone="boo",ltwo="bar"} 1
sample_counter_one{lone="boo",ltwo="far"} 1
sample_counter_one{lone="foo",ltwo="bar"} 1
sample_counter_one{lone="foo",ltwo="far"} 1
# HELP sample_counter_two just a sample counter thats always 2
# TYPE sample_counter_two counter
sample_counter_two{lone="boo",ltwo="bar"} 2
sample_counter_two{lone="boo",ltwo="far"} 2
sample_counter_two{lone="foo",ltwo="bar"} 2
sample_counter_two{lone="foo",ltwo="far"} 2
```
repeat with `docker-compose`
```sh
export COMPOSE_HTTP_TIMEOUT=600
docker-compose up
```
### Baseline

Aside for `localhost` theree is just one target, the `metrics`.
![baseline](https://github.com/sergueik/springboot_study/blob/master/basic-prometheus-relabel-config/screenshots/capture-baseline.png) 

Relabeling the configs will be illustrated next
### Relabel Exercise

* the cluster consists of `prometheus`  prometheus server and a `metrics` node. The latter runs node exporter reading metrics from static file:
```sh
/bin/node_exporter --collector.textfile.directory /tmp/metrics
```
* the `prometheus` node is using custom  prometheus.yml to collect the metrics from `metrics`
```YAML
  - job_name: "static-metrics"
    static_configs:
      - targets:
        # NOTE: port
        - "metrics:9100"
```
* replace the `__address__` with the following yaml:
```YAML
    relabel_configs:
      - source_labels: [__address__]
        regex: "metrics:(.*)"
        target_label: __address__
        replacement: 'monitored_host:$1'
        action: replace
```
This does have effect but it the effect is opposite to what was intended:

![relabel_address](https://github.com/sergueik/springboot_study/blob/master/basic-prometheus-relabel-config/screenshots/capture-relabel_address.png) 

Apparentlty Prometheus does replace the address and failed in attempt to read metrics from the new address directly - the `monitored_host` is not neither is not supposed to be resolvable
### Simple Label
* adding ad-hoc gauge example mertic with an `instance` label

```text
test_gauge{instance="node1"} 23
test_gauge{instance="node2"} 30
```
observed the label to become renamed  tp `exported_instance` while the original `instance` filled with job `static_confgs.target` and `job_name` attributes from `prometheus.yml`:

```text
test_gauge{exported_instance="node1", instance="metrics:9100", job="static-metrics"}
test_gauge{exported_instance="node2", instance="metrics:9100", job="static-metrics"}

```

![relabel_address](https://github.com/sergueik/springboot_study/blob/master/basic-prometheus-relabel-config/screenshots/capture_gauges.png) 
### Troubleshooting 

if any, the error  is likely to be reported by prometheus server:
```sh
SERVICE=prometheus_
CONTAINER=$(docker container ls -a | grep $SERVICE | awk '{print $NF}')
docker logs $CONTAINER
docker exec -it $CONTAINER sh
```
```
SERVICE=metrics_
```
### Cleanup
```sh
docker-compose stop
docker-compose rm -f
```
### See Also

  * https://prometheus.io/docs/instrumenting/exposition_formats/#text-format-example
  * [document with flowcharts](https://www.robustperception.io/life-of-a-label) of Prometheus label processing for service discovery
  * [documentation](https://grafana.com/docs/grafana-cloud/metrics-control-usage/control-prometheus-metrics-usage/usage-reduction/?plcmt=footer) on Prometheus metrics relabeling
  * [documentation](https://prometheus.io/docs/prometheus/latest/configuration/configuration/) covering the `honor_labels` settiang role in specifying how Prometheus handles conflicts between labels that are already present in scraped data and labels that Prometheus would attach server-side (`job` and `instance` labels, manually configured target labels, and labels generated by service discovery implementations) and [example of usage with CouchDB](https://developer.couchbase.com/tutorial-configure-prometheus?learningPath=learn/couchbase-prometheus-integration-guide) and a [bug report](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues/5757) of Prometheus refusing to honor labels when the desired job is not visible and a [discussion](https://stackoverflow.com/questions/57273483/prometheus-honor-labels-how-to-make-it-apply-to-the-internal-metrics-like-sc) of the `honor_labels` limits
  * Grafana Dashoard HTTP API [doc](https://grafana.com/docs/grafana/latest/http_api/dashboard/) 
  * [blog](https://avleonov.com/2020/06/10/how-to-list-create-update-and-delete-grafana-dashboards-via-api/) on list, create, update and delete Grafana dashboards via API
  * [documentation](https://grafanalib.readthedocs.io/en/stable/getting-started.html) for `grafanalib` Python library for generation Grafana dashboards
  * [documentaton](https://grafana.github.io/grafonnet-lib/) on `grafonnet` library for crafting Grafana dashboards (uses the JSON extension DSL as source)
  * [blog](https://brendonmatheson.com/2021/04/03/using-prometheus-relabeling-to-attach-custom-metadata.html) on __Using Prometheus Relabeling to Attach Custom Metadata__ to construct operations-specific dashboard
  * __Building Dashboards from Prometheus Data in Grafana__ pluralsight [course](https://app.pluralsight.com/library/courses/prometheus-grafana-building-dashboards-data/table-of-contents)
  * [comprehensive Prometheus documentation](https://habr.com/ru/company/southbridge/blog/455290/) (in Russian)
  * [Prometheus Server installation and configuration](https://hamsterden.ru/prometheus/) (in Russian)
  * [guide to Prometheus node exporter](https://www.opsramp.com/prometheus-monitoring/prometheus-node-exporter/)


### Author
[Serguei Kouzmine](kouzmine_serguei@yahoo.com)
