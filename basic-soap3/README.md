###  Info


dockerized replica of a simple
[SOAP_Currency_Converter](https://github.com/imexh/SOAP_Currency_Converter) app running Java SOAP web service on plain [Java API for XML Web Services]() (`JAX-WS`)
and interacting with it by flask Web app using Python SOAP client [zeep](https://docs.python-zeep.org/en/master/) module
modified to print the raw SOAP payload when invoked

### Usage


* build server
```sh
cd server
mvn clean package
```
* run server locally
```sh
cd server

java -cp target/example.soap-service.jar example.Application
```
* check server operational
```sh
curl -s http://localhost:8888/CurrencyConversionWebServiceAA1922/?wsdl
```
this will print service definitions WSDL
```XML
<?xml version="1.0" encoding="UTF-8"?>
<!-- Published by JAX-WS RI (http://jax-ws.java.net). RI's version is JAX-WS RI 2.2.9-b130926.1035 svn-revision#5f6196f2b90e9460065a4c2f4e30e065b245e51e. -->
<!-- Generated by JAX-WS RI (http://jax-ws.java.net). RI's version is JAX-WS RI 2.2.9-b130926.1035 svn-revision#5f6196f2b90e9460065a4c2f4e30e065b245e51e. -->
<definitions xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd" xmlns:wsp="http://www.w3.org/ns/ws-policy" xmlns:wsp1_2="http://schemas.xmlsoap.org/ws/2004/09/policy" xmlns:wsam="http://www.w3.org/2007/05/addressing/metadata" xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/" xmlns:tns="http://example/" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns="http://schemas.xmlsoap.org/wsdl/" targetNamespace="http://example/" name="ApplicationService">
  <types>
    <xsd:schema>
      <xsd:import namespace="http://example/" schemaLocation="http://localhost:8888/CurrencyConversionWebService?xsd=1"/>
    </xsd:schema>
  </types>
  <message name="convert">
    <part name="parameters" element="tns:convert"/>
  </message>
  <message name="convertResponse">
    <part name="parameters" element="tns:convertResponse"/>
  </message>
  <message name="IOException">
    <part name="fault" element="tns:IOException"/>
  </message>
  <message name="ParseException">
    <part name="fault" element="tns:ParseException"/>
  </message>
  <message name="getCurrencyList">
    <part name="parameters" element="tns:getCurrencyList"/>
  </message>
  <message name="getCurrencyListResponse">
    <part name="parameters" element="tns:getCurrencyListResponse"/>
  </message>
  <portType name="Application">
    <operation name="convert">
      <input wsam:Action="http://example/Application/convertRequest" message="tns:convert"/>
      <output wsam:Action="http://example/Application/convertResponse" message="tns:convertResponse"/>
      <fault message="tns:IOException" name="IOException" wsam:Action="http://example/Application/convert/Fault/IOException"/>
      <fault message="tns:ParseException" name="ParseException" wsam:Action="http://example/Application/convert/Fault/ParseException"/>
    </operation>
    <operation name="getCurrencyList">
      <input wsam:Action="http://example/Application/getCurrencyListRequest" message="tns:getCurrencyList"/>
      <output wsam:Action="http://example/Application/getCurrencyListResponse" message="tns:getCurrencyListResponse"/>
      <fault message="tns:IOException" name="IOException" wsam:Action="http://example/Application/getCurrencyList/Fault/IOException"/>
      <fault message="tns:ParseException" name="ParseException" wsam:Action="http://example/Application/getCurrencyList/Fault/ParseException"/>
    </operation>
  </portType>
  <binding name="ApplicationPortBinding" type="tns:Application">
    <soap:binding transport="http://schemas.xmlsoap.org/soap/http" style="document"/>
    <operation name="convert">
      <soap:operation soapAction=""/>
      <input>
        <soap:body use="literal"/>
      </input>
      <output>
        <soap:body use="literal"/>
      </output>
      <fault name="IOException">
        <soap:fault name="IOException" use="literal"/>
      </fault>
      <fault name="ParseException">
        <soap:fault name="ParseException" use="literal"/>
      </fault>
    </operation>
    <operation name="getCurrencyList">
      <soap:operation soapAction=""/>
      <input>
        <soap:body use="literal"/>
      </input>
      <output>
        <soap:body use="literal"/>
      </output>
      <fault name="IOException">
        <soap:fault name="IOException" use="literal"/>
      </fault>
      <fault name="ParseException">
        <soap:fault name="ParseException" use="literal"/>
      </fault>
    </operation>
  </binding>
  <service name="ApplicationService">
    <port name="ApplicationPort" binding="tns:ApplicationPortBinding">
      <soap:address location="http://localhost:8888/CurrencyConversionWebService"/>
    </port>
  </service>
</definitions>
```
* run client locally (if there is a Python environmnent on the developent machine)
```sh
cd client
python main.py
```
console shows
```
 * Serving Flask app 'CurrencyConverter'
 * Debug mode: on
 WARNING: This is a development server. Do not use it
 Use a production WSGI server instead.
 * Running on http://127.0.0.1:5000
 Press CTRL+C to quit
 * Debugger is active!
 * Debugger PIN: 247-604-278
```
* interact via browser

![Client](https://github.com/sergueik/springboot_study/blob/master/basic-soap3/screenshots/capture-client.png)

* check client console logs once submitted:

```XML
<?xml version="1.0"?>
<soap-env:Envelope xmlns:soap-env="http://schemas.xmlsoap.org/soap/envelope/">
  <soap-env:Header xmlns:wsa="http://www.w3.org/2005/08/addressing">
    <wsa:Action>http://example/Application/convertRequest</wsa:Action>
    <wsa:MessageID>urn:uuid:a666e2b0-e392-4dd6-ac10-3abff9abfb73</wsa:MessageID>
    <wsa:To>http://192.168.0.25:8888/CurrencyConversionWebService</wsa:To>
  </soap-env:Header>
  <soap-env:Body>
    <ns0:convert xmlns:ns0="http://example/">
      <arg0>19</arg0>
      <arg1>AED</arg1>
      <arg2>BAM</arg2>
    </ns0:convert>
  </soap-env:Body>
</soap-env:Envelope>
```
*  run in Docker
```sh
docker-compose up --build
```
* test in the console
```sh
curl -X POST -d "currencyName1=AFN&currencyName2=AED&value1=10.0" http://localhost:5000/
```
this will print the page to the console:
```HTML
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <title>Currency Converter</title>
  </head>
  <body>
    <div style="max-width: 500px; margin: auto; text-align: center;">
      <h1>Currency Converter</h1>
    </div>
    <div style="max-width: 500px; margin: auto">
      <form method="post" action="/" style="text-align: center;">
        <table>
          <tr>
            <td colspan="3">
              <input style="width: 500px;" type="number" name="value1" required="required" placeholder="Enter amount"/>
            </td>
          </tr>
          <tr>
            <td>
              <select style="width: 200px; text-align: center;" name="currencyName1" id="currencyName1">
                            <option value="AED">AED</option>
                            <option value="AFN">AFN</option>
                            <option value="ALL">ALL</option>
                            <option value="AMD">AMD</option>
                            <option value="ANG">ANG</option>
                            <option value="AOA">AOA</option>
                            <option value="ARS">ARS</option>
                            <option value="AUD">AUD</option>
                            ...
                        </select>
            </td>
            <td>
              <h1 style="width: 100px; text-align: center;">=&gt;</h1>
            </td>
            <td>
              <select style="width: 200px; text-align: center;" name="currencyName2" id="currencyName2">
                            <option value="AED">AED</option>
                            <option value="AFN">AFN</option>
                            <option value="ALL">ALL</option>
                            <option value="AMD">AMD</option>
                            <option value="ANG">ANG</option>
                            <option value="AOA">AOA</option>
                            <option value="ARS">ARS</option>
                            <option value="AUD">AUD</option>
                            ...
                        </select>
            </td>
          </tr>
          <tr>
            <td colspan="3">
              <input style="width: 500px;" type="submit" value="Convert"/>
            </td>
          </tr>
        </table>
      </form>
      <h3 style="text-align: center; width: 500px;">10.0 AFN =&gt; 0.48 AED</h3>
    </div>
  </body>
</html>
```
NOTE: if run in [Docker Toolbox](https://github.com/docker/toolbox), use the ip address on network adapter which is connected to __Host-only__ network `192.168.99.0`.

```
curl -s http://192.168.99.100:500/
```
if seeing the error
```sh
curl -s http://192.168.99.100:5000/
$ echo $?
```
```text
7
```
```text
curl: (7) Failed to connect to 192.168.99.100 port 5000: Connection refused

```
then connect directly to the container ip.
Find it via

```sh
docker inspect  client | /c/tools/jq-win64.exe  ".[0].NetworkSettings.Networks"
```
```
{
  "basic-soap3_example": {
    "IPAMConfig": null,
    "Links": null,
    "Aliases": [
      "client",
      "eeac066a4a19"
    ],
    "NetworkID": "2626833edfbc2433545fa284b296582651e8adca709335baceac0bacfe67d591",
    "EndpointID": "7a8d59c6c3f42beec59d80af380ff774065011d88d9d3ec2373f5e709b72a36c",
    "Gateway": "172.22.0.1",
    "IPAddress": "172.22.0.3",
    "IPPrefixLen": 16,
    "IPv6Gateway": "",
    "GlobalIPv6Address": "",
    "GlobalIPv6PrefixLen": 0,
    "MacAddress": "02:42:ac:16:00:03",
    "DriverOpts": null
  }
}
```
then

```sh
curl http://172.22.0.3:5000/
```

if seeing the same error

then connect to the client via docker exec:
```sh
docker exec -it client sh
```

```sh
lynx http://localhost:5000/
```

![Lynx](https://github.com/sergueik/springboot_study/blob/master/basic-soap3/screenshots/capture-lynx.png)
the soap will be logged to the console log
```sh
docker logs client
```
```text
client         | 127.0.0.1 - - [05/Jan/2023 00:46:46] "GET / HTTP/1.1" 200 -
client         | b'<soap-env:Envelope xmlns:soap-env="http://schemas.xmlsoap.org
/soap/envelope/">\n  <soap-env:Header xmlns:wsa="http://www.w3.org/2005/08/addre
ssing">\n    <wsa:Action>http://example/Application/convertRequest</wsa:Action>\
n    <wsa:MessageID>urn:uuid:78728a50-95b6-4778-a06b-bfadffdde75c</wsa:MessageID
>\n    <wsa:To>http://soap-server:8888/CurrencyConversionWebService</wsa:To>\n
</soap-env:Header>\n  <soap-env:Body>\n    <ns0:convert xmlns:ns0="http://exampl
e/">\n      <arg0>10</arg0>\n      <arg1>AED</arg1>\n      <arg2>ANG</arg2>\n
 </ns0:convert>\n  </soap-env:Body>\n</soap-env:Envelope>\n'
 client         | 127.0.0.1 - - [05/Jan/2023 00:46:47] "POST / HTTP/1.0" 200 -
 client         | 127.0.0.1 - - [05/Jan/2023 00:46:56] "GET / HTTP/1.1" 200 -
```
###  TODO

currently if no arguments in the SOAP call are provided:
```python
node = client.create_message(client.service, 'convert');
```
the exception is not very informative:

```text
zeep.exceptions.ValidationError: Missing element arg0 (convert.arg0)
```
full text
```text
127.0.0.1 - - [04/Jan/2023 17:51:54] "POST / HTTP/1.1" 500 -
Traceback (most recent call last):
  File "flask\app.py", line 2548, in __call__
    return self.wsgi_app(environ, start_response)
  File "flask\app.py", line 2528, in wsgi_app
    response = self.handle_exception(e)
  File "flask\app.py", line 2525, in wsgi_app
    response = self.full_dispatch_request()
  File "flask\app.py", line 1822, in full_dispatch_request
    rv = self.handle_user_exception(e)
  File "flask\app.py", line 1820, in full_dispatch_request
    rv = self.dispatch_request()
  File "flask\app.py", line 1796, in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)
  File "main.py", line 26, in currencyConvert
    node = client.create_message(client.service, 'convert');
  File "zeep\client.py", line 151, in create_message
    operation_name, args, kwargs, client=self
  File "zeep\wsdl\bindings\soap.py", line 73, in_create
    serialized = operation_obj.create(*args, **kwargs)
  File "zeep\wsdl\definitions.py", line 224, in create
    return self.input.serialize(*args, **kwargs)
  File "zeep\wsdl\messages\soap.py", line 79, in serialize
    self.body.render(body, body_value)
  File "zeep\xsd\elements\element.py", line 232, in render
    self._render_value_item(parent, value, render_path)
  File "zeep\xsd\elements\element.py", line 256, in _render_value_item
    return self.type.render(node, value, None, render_path)
  File "zeep\xsd\types\complex.py", line 307, in render
    element.render(node, element_value, child_path)
  File "zeep\xsd\elements\indicators.py", line 256, in render
    element.render(parent, element_value, child_path)
  File "zeep\xsd\elements\element.py", line 226, in render
    self.validate(value, render_path)
  File "zeep\xsd\elements\element.py", line 285, in validate
    "Missing element %s" % (self.name), path=render_path
zeep.exceptions.ValidationError: Missing element arg0 (convert.arg0)
```
### See Also

   * [lxml - XML and HTML with Python](https://lxml.de)
   * [zeep - Python SOAP client](https://docs.python-zeep.org/en/master/)
   * [plain Java Web Service](https://docs.oracle.com/javase/7/docs/api/javax/jws/package-summary.html)
   * [Introduction to JAX-WS](https://www.baeldung.com/jax-ws)
   * [java-ws and .net interop example](https://gridwizard.wordpress.com/2014/12/26/java-ws-and-dotnet-interop-example/)



### Author
[Serguei Kouzmine](kouzmine_serguei@yahoo.com)
